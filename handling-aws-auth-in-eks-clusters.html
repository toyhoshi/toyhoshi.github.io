<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"><title>Handling aws-auth in EKS Clusters - www.clouday.dev</title><meta name="description" content=" If you use EKS then you have found yourself in a situation where a user can't access the cluster despite having all the IAM&hellip;"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://www.clouday.dev/handling-aws-auth-in-eks-clusters.html"><link rel="alternate" type="application/atom+xml" href="https://www.clouday.dev/feed.xml"><link rel="alternate" type="application/json" href="https://www.clouday.dev/feed.json"><meta property="og:title" content="Handling aws-auth in EKS Clusters"><meta property="og:site_name" content="www.clouday.dev"><meta property="og:description" content=" If you use EKS then you have found yourself in a situation where a user can't access the cluster despite having all the IAM&hellip;"><meta property="og:url" content="https://www.clouday.dev/handling-aws-auth-in-eks-clusters.html"><meta property="og:type" content="article"><link rel="shortcut icon" href="https://www.clouday.dev/media/website/favicon.ico" type="image/x-icon"><link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin><link href="https://fonts.googleapis.com/css?family=Dosis:400,600&amp;display=swap" rel="stylesheet"><style>:root{--primary-font:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Oxygen,Ubuntu,Cantarell,"Fira Sans","Droid Sans","Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol";--secondary-font:'Dosis',sans-serif}</style><link rel="stylesheet" href="https://www.clouday.dev/assets/css/fontawesome-all.min.css?v=bbcde81f26378440dac4c3d195714389"><link rel="stylesheet" href="https://www.clouday.dev/assets/css/style.css?v=c5595450718e9b8706c1d0ae208d0265"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://www.clouday.dev/handling-aws-auth-in-eks-clusters.html"},"headline":"Handling aws-auth in EKS Clusters","datePublished":"2021-12-30T16:25","dateModified":"2022-01-29T16:25","description":" If you use EKS then you have found yourself in a situation where a user can't access the cluster despite having all the IAM&hellip;","author":{"@type":"Person","name":"Toyhoshi"},"publisher":{"@type":"Organization","name":"Toyhoshi"}}</script></head><body class="is-preload"><div id="wrapper"><div id="main"><div class="inner"><header id="header"><a class="logo" href="https://www.clouday.dev/"><strong>www.clouday.dev</strong></a><ul class="icons"><li><a href="https://twitter.com/toyhoshi" class="icon brands fa-twitter"><span class="label">Twitter</span></a></li><li><a href="https://www.linkedin.com/in/marcovaragnolo" class="icon brands fa-linkedin"><span class="label">LinkedIn</span></a></li></ul></header><article class="post"><header class="main post__header"><time datetime="2021-12-30T16:25" class="post__date">Dec 30, 2021</time><h1>Handling aws-auth in EKS Clusters</h1></header><div class="post__inner post__entry"><p><img loading="lazy" src="https://images.unsplash.com/photo-1559599173-92df446bb253?ixlib=rb-1.2.1&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=1000&amp;q=80" data-is-external-image="true" alt="stacked magazine"></p><p>If you use EKS then you have found yourself in a situation where a user can't access the cluster despite having all the IAM permissions and gets an <code>Unauthorized</code> message.  AWS EKS uses <code>IAM credentials</code> for <code>authentication</code> and <code>Kubernetes RBAC</code> for <code>authorization</code>. As per <a href="https://docs.aws.amazon.com/eks/latest/userguide/managing-auth.html">EKS docs</a>:</p><blockquote><p><code>EKS uses IAM permissions for authentication of valid entities such IAM users or roles. All the permissions for interacting with the EKS cluster is managed through Kubernetes RBAC</code></p></blockquote><p>or simply put, EKS doesn't work the same way as other services such as S3 where if you have <code>AmazonS3FullAccess</code>, you can access any S3 bucket and create or delete files/folders. In EKS, IAM permissions are only used to check if the user has valid IAM credentials and permissions to run any command using <code>kubectl</code> such as <code>kubectl get pods</code> is managed by Kubernetes API that uses <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">RBAC</a> to control the access.</p><p>By default, the <code>IAM Role</code> or <code>IAM User</code> that was used to create the cluster, is added to the <code>system:masters</code> group and gets cluster-wide admin permission with <code>cluster-admin</code> ClusterRole.</p><p>As per <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles">Kubernetes documentation</a> <code>system:masters</code> group is one of the <code>default</code> ClusterRoleBindings available in the Kubernetes cluster, it's attached to the <code>cluster-admin</code> ClusterRole that gives the user admin permissions in the cluster.</p><div class="table-wrapper-paragraph"><table><thead><tr><th>Default ClusterRole</th><th>Default ClusterRoleBinding</th><th>Description</th></tr></thead><tbody><tr><td>cluster-admin</td><td>system:masters group</td><td>Allows super-user access to perform any action on any resource.</td></tr></tbody></table></div><p><strong>Note:</strong> This mapping of creator IAM User or Role to <code>system:masters</code> group is not visible in any configuration such as <code>aws-auth</code> configmap.</p><p>EKS allows giving access to other users by adding them in a configmap <code>aws-auth</code> in <code>kube-system</code> namespace. By default, this configmap is empty. However, If you are using <code>eksctl</code> to create the cluster, this config map will have the role created by <code>eksctl</code> for the node group and this role is attached to the <code>system:bootstrappers</code> and <code>system:nodes</code> groups.</p><p><code>aws-auth</code> configmap is based on <a href="https://github.com/kubernetes-sigs/aws-iam-authenticator">aws-iam-authenticator</a> and has several configuration options:</p><ol><li><strong>mapRoles</strong></li><li><strong>mapUsers</strong></li><li><strong>mapAccounts</strong></li></ol><h2> </h2><h2><a name="using-maproles-to-map-an-iam-role-to-the-cluster" href="https://dev.to/aws-builders/eks-auth-deep-dive-4fib#using-maproles-to-map-an-iam-role-to-the-cluster"></a>Using mapRoles to Map an IAM Role to the Cluster</h2><p><code>mapRoles</code> allows mapping an <code>IAM role</code> in the cluster to allow any entity or user assuming that role to access the cluster. After mapping an IAM role with <code>mapRoles</code>, any user or entity assuming this role is allowed to access the cluster, However, the level of access is defined by the <code>groups</code> attribute.</p><p><code>mapRoles</code> has three attributes:</p><ol><li><strong>rolearn</strong> - IAM Role ARN to map to EKS cluster.</li><li><strong>username</strong> - Username for the IAM Role to map in Kubernetes, this could be a static value like <code>eks-developer</code> or <code>ci-account</code> or a templated variable like <code>{{AccountID}}/{{SessionName}}/{{EC2PrivateDNSName}}</code> or both. This value would be printed in the <code>aws-authenticator</code> Cloudwatch logs if logging is enabled.</li><li><strong>groups</strong> - List of Kubernetes groups that are defined in <code>ClusterRoleBinding/RoleBinding</code>. Example</li></ol><div class="highlight js-code-highlight"><pre class="highlight yaml"><code>  <span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">my-group"</span>
    <span class="na">apiGroup</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre><div class="highlight__panel js-actions-panel"><div class="highlight__panel-action js-fullscreen-code-action"><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Let's create two IAM roles </span><code style="font-weight: var(--font-weight-normal);">eks-admin</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> and </span><code style="font-weight: var(--font-weight-normal);">eks-dev</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> and assume the </span><code style="font-weight: var(--font-weight-normal);">eks-admin</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> role to create a cluster with one node group:</span></div></div></div><div class="highlight js-code-highlight"><pre class="highlight yaml"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">eksctl.io/v1alpha5</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterConfig</span>

<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">iam-auth-cluster</span>
  <span class="na">region</span><span class="pi">:</span> <span class="s">us-east-1</span>
  <span class="na">version</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1.21"</span>

<span class="na">availabilityZones</span><span class="pi">:</span> 
  <span class="pi">-</span> <span class="s">us-east-1a</span>
  <span class="pi">-</span> <span class="s">us-east-1b</span>
  <span class="pi">-</span> <span class="s">us-east-1c</span>

<span class="na">cloudWatch</span><span class="pi">:</span>
  <span class="na">clusterLogging</span><span class="pi">:</span>
    <span class="na">enableTypes</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">authenticator"</span><span class="pi">]</span>

<span class="na">managedNodeGroups</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">managed-ng-1</span>
    <span class="na">instanceType</span><span class="pi">:</span> <span class="s">t2.micro</span>
    <span class="na">minSize</span><span class="pi">:</span> <span class="m">1</span>
    <span class="na">maxSize</span><span class="pi">:</span> <span class="m">4</span>
    <span class="na">desiredCapacity</span><span class="pi">:</span> <span class="m">4</span>
</code></pre><div class="highlight__panel js-actions-panel"><div class="highlight__panel-action js-fullscreen-code-action"><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Once created, this cluster would have one NodeGroup and the IAM role associated with this node group would be added to the </span><code style="font-weight: var(--font-weight-normal);">aws-auth</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> configmap. </span><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Check the contents of </span><code style="font-weight: var(--font-weight-normal);">aws-auth</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> configMap :</span></div></div></div><div class="highlight js-code-highlight"><pre class="highlight shell"><code>kubectl get configmap aws-auth <span class="nt">-n</span> kube-system <span class="nt">-oyaml</span>
</code></pre></div><div class="highlight js-code-highlight"><pre class="highlight yaml"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">mapRoles</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">- groups:</span>
      <span class="s">- system:bootstrappers</span>
      <span class="s">- system:nodes</span>
      <span class="s">rolearn: arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/eksctl-iam-auth-cluster-nodegroup-NodeInstanceRole-1RNKIEA50ZD0B</span>
      <span class="s">username: system:node:{{EC2PrivateDNSName}}</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">aws-auth</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
</code></pre><div class="highlight__panel js-actions-panel"><div class="highlight__panel-action js-fullscreen-code-action"><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">By default, only </span><code style="font-weight: var(--font-weight-normal);">IAM Role</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> that created the cluster would have access to the cluster, any other IAM Role has to be added separately added in </span><code style="font-weight: var(--font-weight-normal);">aws-auth</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">. Let's try to assume the </span><code style="font-weight: var(--font-weight-normal);">eks-developer</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> IAM role and try to access the cluster with that role.</span></div></div></div><div class="highlight js-code-highlight"><pre class="highlight shell"><code>kubectl get pods

error: You must be logged <span class="k">in </span>to the server <span class="o">(</span>Unauthorized<span class="o">)</span>
</code></pre><div class="highlight__panel js-actions-panel"><div class="highlight__panel-action js-fullscreen-code-action"><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">As expected, </span><code style="font-weight: var(--font-weight-normal);">eks-developer</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> IAM role would not be allowed access. To allow </span><code style="font-weight: var(--font-weight-normal);">eks-developer</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> IAM role access to the cluster, add the mapping in the </span><code style="font-weight: var(--font-weight-normal);">aws-auth</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> configMap to map this role to </span><code style="font-weight: var(--font-weight-normal);">eks-developer</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> Kubernetes user. We can either directly edit the configMap or use </span><code style="font-weight: var(--font-weight-normal);">eksctl</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> to add this mapping:</span></div></div></div><div class="highlight js-code-highlight"><pre class="highlight shell"><code>eksctl create iamidentitymapping <span class="se">\</span>
  <span class="nt">--cluster</span> iam-auth-cluster <span class="se">\</span>
  <span class="nt">--region</span> us-east-1 <span class="se">\</span>
  <span class="nt">--arn</span> <span class="s2">"arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/eks-developer"</span> <span class="se">\</span>
  <span class="nt">--username</span> <span class="s2">"eks-developer"</span>
</code></pre><div class="highlight__panel js-actions-panel"><div class="highlight__panel-action js-fullscreen-code-action"><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">this would create an entry under the </span><code style="font-weight: var(--font-weight-normal);">mapRoles</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> section in </span><code style="font-weight: var(--font-weight-normal);">aws-auth</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> configMap :</span></div></div></div><div class="highlight js-code-highlight"><pre class="highlight yaml"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">mapRoles</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">- groups:</span>
      <span class="s">- system:bootstrappers</span>
      <span class="s">- system:nodes</span>
      <span class="s">rolearn: arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/eksctl-iam-auth-cluster-nodegroup-NodeInstanceRole-1RNKIEA50ZD0B</span>
      <span class="s">username: system:node:{{EC2PrivateDNSName}}</span>

    <span class="s">- rolearn: arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/eks-developer</span>
      <span class="s">username: eks-developer</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">aws-auth</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">kube-system</span>
</code></pre><div class="highlight__panel js-actions-panel"><div class="highlight__panel-action js-fullscreen-code-action"><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Let's try again accessing cluster by assuming the </span><code style="font-weight: var(--font-weight-normal);">eks-developer</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> IAM role:</span></div></div></div><div class="highlight js-code-highlight"><pre class="highlight shell"><code>kubectl get pods

Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: pods is forbidden: User <span class="s2">"eks-developer"</span> cannot list resource <span class="s2">"pods"</span> <span class="k">in </span>API group <span class="s2">""</span> at the cluster scope
</code></pre><div class="highlight__panel js-actions-panel"><div class="highlight__panel-action js-fullscreen-code-action"><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">This time, we can access the cluster, however not allowed to list pods in the cluster due to not having enough RBAC permissions. RBAC permissions can be assigned to this IAM role in two ways :</span></div></div></div><p><strong>1. RBAC permissions with Kubernetes User</strong><br><strong>2. RBAC permissions with Kubernetes Groups</strong></p><h3> </h3><h3><a name="rbac-permissions-with-kubernetes-user" href="https://dev.to/aws-builders/eks-auth-deep-dive-4fib#rbac-permissions-with-kubernetes-user"></a>RBAC permissions with Kubernetes User</h3><p>We can assign RBAC permissions to an IAM role by binding mapped <code>Kubernetes User</code> in <code>aws-auth</code> i.e <code>eks-developer</code> to a <code>ClusterRole</code>/<code>Role</code>.</p><ol><li><p>Create a <strong>ClusterRole</strong> <code>eks-developer-cluster-role</code> with permissions to <code>get</code>, <code>list</code> or <code>watch</code> the <code>pods</code> resources :</p><pre class="highlight yaml"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">eks-developer-cluster-role</span>
<span class="na">rules</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">apiGroups</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">"</span><span class="pi">]</span> <span class="c1"># Pod is part of Core API Group and "" indicates the core API group</span>
    <span class="na">resources</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">pods"</span><span class="pi">]</span> <span class="c1"># pods resource</span>
    <span class="na">verbs</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">get"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">list"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">watch"</span><span class="pi">]</span> <span class="c1"># Allow user to get, list of watch the pods.</span>
</code></pre></li><li><p>We have mapped IAM role <code>arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/eks-developer</code> to Kubernetes user <code>eks-developer</code> in <code>aws-auth</code>, now create a <strong>ClusterRoleBinding</strong> to bind <code>developer-cluster-role</code> to the Kubernetes user <code>eks-developer</code>.</p><pre class="highlight yaml"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">eks-developer-user-cluster-role-binding</span>
<span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">User</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">eks-developer</span> <span class="c1"># Kubernetes User mapped to the IAM role in aws-auth configmap.</span>
    <span class="na">apiGroup</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">eks-developer-cluster-role</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre></li><li><p>Access the cluster again by assuming the IAM role <code>eks-developer</code></p><pre class="highlight shell"><code>kubectl get pods <span class="nt">-A</span>

NAMESPACE     NAME                       READY   STATUS    RESTARTS   AGE
kube-system   aws-node-f584p             1/1     Running   0          79m
kube-system   coredns-66cb55d4f4-8hjj2   1/1     Running   0          91m
kube-system   coredns-66cb55d4f4-vtf6j   1/1     Running   0          91m
kube-system   kube-proxy-psjk5           1/1     Running   0          79m
</code></pre></li></ol><p>and this time it works!!! <code></code></p><h3> </h3><h3><a name="rbac-permissions-with-kubernetes-groups" href="https://dev.to/aws-builders/eks-auth-deep-dive-4fib#rbac-permissions-with-kubernetes-groups"></a>RBAC permissions with Kubernetes Groups</h3><p>While assigning permissions directly to the Kubernetes User works just fine for most of the use-cases however this approach is not so great if you want to audit who is assuming the IAM role and accessing the cluster and would like additional information captured in the audit logs.</p><p>One such use-case is <strong>AWS SSO</strong>, where many users are assigned to a permission set and whenever these users log in using their credentials, they assume the same <code>IAM role</code>.</p><p>We can assign IAM permissions to an IAM role by creating a Kubernetes Group and add it to the <code>mapRoles.groups</code> field of IAM Role mapping in <code>aws-auth</code>.</p><p>Let's take the earlier example of the <code>eks-developer</code> IAM role and create a ClusterRoleBinding with Kubernetes Group <code>developer</code> bound to <code>eks-developer-cluster-role</code> and add Kubernetes Group <code>developer</code> in the mapping of this IAM role in <code>aws-auth</code>.</p><ol><li><p>First delete the earlier ClusterRoleBinding <code>eks-developer-user-cluster-role-binding</code> :</p><pre class="highlight shell"><code>kubectl delete clusterrolebindings eks-developer-user-cluster-role-binding
clusterrolebinding.rbac.authorization.k8s.io <span class="s2">"eks-developer-user-cluster-role-binding"</span> deleted
</code></pre><p>As soon as we delete the <code>ClusterRolebinding</code>, <code>eks-developer</code> IAM role won't be able to list the pods, let's check the access by assuming the <code>eks-developer</code> IAM role :</p><pre class="highlight shell"><code>kubectl get pods <span class="nt">-A</span>
Error from server <span class="o">(</span>Forbidden<span class="o">)</span>: pods is forbidden: User <span class="s2">"eks-developer"</span> cannot list resource <span class="s2">"pods"</span> <span class="k">in </span>API group <span class="s2">""</span> <span class="k">in </span>the namespace <span class="s2">"default"</span>
</code></pre></li><li><p>Delete <strong>IAM Mapping</strong> from <code>aws-auth</code> :</p><pre class="highlight shell"><code>eksctl delete iamidentitymapping <span class="se">\</span>
      <span class="nt">--cluster</span> iam-auth-cluster <span class="se">\</span>
      <span class="nt">--region</span> us-east-1 <span class="se">\</span>
      <span class="nt">--arn</span> <span class="s2">"arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/eks-developer"</span>
</code></pre></li><li><p>Create a <strong>ClusterRoleBinding</strong> to bind Kubernetes Group <code>developer</code> to cluster role <code>eks-developer-cluster-role</code>:</p><pre class="highlight yaml"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">eks-developer-group-cluster-role-binding</span>
<span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">developer</span>
    <span class="na">apiGroup</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">eks-developer-cluster-role</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre></li><li><p>Add Kubernetes Group <code>developer</code> to IAM role mapping of <code>eks-developer</code> in <code>aws-auth</code> and include the session name in username using templated variable <code>{{SessionName}}</code>:</p><pre class="highlight shell"><code>eksctl create iamidentitymapping <span class="se">\</span>
  <span class="nt">--cluster</span> iam-auth-cluster <span class="se">\</span>
  <span class="nt">--region</span> us-east-1 <span class="se">\</span>
  <span class="nt">--arn</span> <span class="s2">"arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/eks-developer"</span> <span class="se">\</span>
  <span class="nt">--username</span> <span class="s2">"eks-developer:{{SessionName}}"</span> <span class="se">\</span>
  <span class="nt">--group</span> <span class="s2">"developer"</span>
</code></pre><p>this would create an entry under <code>mapRoles</code> section in <code>aws-auth</code> configmap as:</p><pre class="highlight yaml"><code><span class="na">mapRoles</span><span class="pi">:</span> <span class="pi">|</span>
  <span class="s">- groups:</span>
    <span class="s">- developer</span>
    <span class="s">rolearn: arn:aws:iam::017558828988:role/eks-developer</span>
    <span class="s">username: eks-developer:{{SessionName}}</span>
</code></pre></li></ol><p>Check the Cloudwatch <code>authenticator</code> logs for the authenticated user assuming <code>eks-developer</code> IAM role and we can see that this time session name is appended to the username in logs:</p><p class="msg msg--info"><code>time="2021-09-13T17:57:46Z" level=info msg="access granted" arn="arn:aws:iam::0175XXXXXXXX:role/eks-developer" client="127.0.0.1:48520" groups="[developer]" method=POST path=/authenticate sts=sts.us-east-1.amazonaws.com uid="heptio-authenticator-aws:0175XXXXXXXX:AROAQIFUWO66PDOXKSLMQ" username="eks-developer:eks-developer-session"</code></p><p>If the session name consists of <code>@</code>, it would be replaced with <code>-</code>. Let's assume the IAM role <code>eks-developer</code> with session name containing <code>@</code> :</p><div class="highlight js-code-highlight"><pre class="highlight shell"><code>aws sts assume-role <span class="se">\</span>
    <span class="nt">--role-arn</span> <span class="s2">"&lt;IAM_ROLE_ARN&gt;"</span> <span class="se">\</span>
    <span class="nt">--role-session-name</span> <span class="s2">"my-develper-session@123456789"</span> <span class="se">\</span>
    <span class="nt">--duration-seconds</span> 3600</code></pre></div><p>Now Cloudwatch logs would have session name printed as <code>eks-developer:my-developer-session-123456789</code>.</p><p class="msg msg--info"><code>time="2021-09-14T17:50:25Z" level=info msg="access granted" arn="arn:aws:iam::017558828988:role/eks-developer" client="127.0.0.1:57794" groups="[developer]" method=POST path=/authenticate sts=sts.us-east-1.amazonaws.com uid="heptio-authenticator-aws:017558828988:AROAQIFUWO66PDOXKSLMQ" username="eks-developer:my-develper-session-123456789"</code></p><p>There is one problem here, if your EKS cluster is being accessed from <strong>multiple AWS accounts</strong>, it would not be possible to track the AWS account of the user who accessed the EKS cluster just by session name.</p><p><code>{{AccountID}}</code> comes to the rescue, we can use this templated variable to get the <strong>AWS account ID</strong> of the user who is assuming the role, so we can set the username to :</p><div class="highlight js-code-highlight"><pre class="highlight shell"><code>aws:<span class="o">{{</span>AccountID<span class="o">}}</span>:eks-developer:<span class="o">{{</span>SessionName<span class="o">}}</span>
</code></pre><div class="highlight__panel js-actions-panel"><div class="highlight__panel-action js-fullscreen-code-action"><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Please note that </span><code style="font-weight: var(--font-weight-normal);">iamidentitymapping</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> can't be overridden with </span><code style="font-weight: var(--font-weight-normal);">eksctl</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">, so you have to delete it and create it again.</span></div></div></div><div class="highlight js-code-highlight"><pre class="highlight shell"><code>eksctl delete iamidentitymapping <span class="se">\</span>
      <span class="nt">--cluster</span> <span class="s2">"iam-auth-cluster"</span> <span class="se">\</span>
      <span class="nt">--region</span> <span class="s2">"us-east-1"</span> <span class="se">\</span>
      <span class="nt">--arn</span> <span class="s2">"arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/eks-developer"</span>

eksctl create iamidentitymapping <span class="se">\</span>
      <span class="nt">--cluster</span> <span class="s2">"iam-auth-cluster"</span> <span class="se">\</span>
      <span class="nt">--region</span> <span class="s2">"us-east-1"</span> <span class="se">\</span>
      <span class="nt">--arn</span> <span class="s2">"arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/eks-developer"</span> <span class="se">\</span>
      <span class="nt">--username</span> <span class="s2">"aws:{{AccountID}}:eks-developer:{{SessionName}}"</span> <span class="se">\</span>
      <span class="nt">--group</span> <span class="s2">"developer"</span>
</code></pre><div class="highlight__panel js-actions-panel"><div class="highlight__panel-action js-fullscreen-code-action"><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Now we would get the </span><code style="font-weight: var(--font-weight-normal);">AWS Account ID</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> along with </span><code style="font-weight: var(--font-weight-normal);">Session Name</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> in cloudwatch logs :</span></div></div></div><p class="msg msg--info"><code>time="2021-09-14T18:26:33Z" level=info msg="access granted" arn="arn:aws:iam::017558828988:role/eks-developer" client="127.0.0.1:39752" groups="[developer]" method=POST path=/authenticate sts=sts.us-east-1.amazonaws.com uid="heptio-authenticator-aws:0175XXXXXXXX:AROAQIFUWO66PDOXKSLMQ" username="aws:0175XXXXXXXX:eks-developer:my-develper-session-123456789"</code></p><p><strong>Note: If you want session name in raw format, you can use templated variable <code>{{SessionNameRaw}}</code> instead. However as of EKS 1.21, these two variables <code>{{AccessKeyID}}</code> and <code>{{SessionNameRaw}}</code> don't work.</strong></p><h2> </h2><h2><a name="using-mapuser-to-map-an-iam-user-to-the-cluster" href="https://dev.to/aws-builders/eks-auth-deep-dive-4fib#using-mapuser-to-map-an-iam-user-to-the-cluster"></a>Using mapUser to Map an IAM User to the Cluster</h2><p><code>mapUsers</code> allows mapping an <code>IAM User</code> to the cluster and add the user to one or more Kubernetes Groups. It has 3 attributes :</p><ol><li><strong>userarn</strong> - ARN of IAM User to map to EKS cluster. This could be an IAM user from the same AWS account or another account.</li><li><strong>username</strong> - Static username to map this IAM User to, in Kubernetes.</li><li><strong>groups</strong> - List of Kubernetes groups that are defined in <code>ClusterRoleBinding/RoleBinding</code>.</li></ol><p><strong>Note: Templated variables are not supported in <code>username</code> field with mapUser.</strong></p><p>To add an IAM user with ARN <code>arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:user/dev-user</code> in <code>aws-auth</code> configmap, we can run the below command:</p><div class="highlight js-code-highlight"><pre class="highlight shell"><code>eksctl create iamidentitymapping <span class="se">\</span>
  <span class="nt">--cluster</span> iam-auth-cluster <span class="se">\</span>
  <span class="nt">--region</span> us-east-1 <span class="se">\</span>
  <span class="nt">--arn</span> <span class="s2">"arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:user/dev-user"</span> <span class="se">\</span>
  <span class="nt">--username</span> <span class="s2">"dev-user"</span></code></pre></div><p>this command would add these lines in <code>aws-auth</code> configMap:</p><div class="highlight js-code-highlight"><pre class="highlight yaml"><code>  <span class="na">mapUsers</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">- userarn: arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:user/dev-user</span>
      <span class="s">username: dev-user</span>
</code></pre><div class="highlight__panel js-actions-panel"><div class="highlight__panel-action js-fullscreen-code-action"><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Since we didn't specify any group, </span><code style="font-weight: var(--font-weight-normal);">dev-user</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> would be able to authenticate to the cluster, however wouldn't be able to </span><code style="font-weight: var(--font-weight-normal);">list</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> or </span><code style="font-weight: var(--font-weight-normal);">get</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> any resources.</span></div></div></div><p>For users mapped using <code>mapUsers</code>, RBAC permission can be given in two ways :</p><p><strong>1. RBAC permissions with Kubernetes User</strong><br><strong>2. RBAC permissions with Kubernetes Groups</strong></p><h3> </h3><h3><a name="rbac-permissions-with-kubernetes-user" href="https://dev.to/aws-builders/eks-auth-deep-dive-4fib#rbac-permissions-with-kubernetes-user"></a>RBAC permissions with Kubernetes User</h3><p>We can assign RBAC permissions to an <code>IAM user</code> by binding mapped <code>Kubernetes User</code> in <code>aws-auth</code> i.e <code>dev-user</code> to a <code>ClusterRole</code>/<code>Role</code>.</p><ol><li><p>Create a <strong>ClusterRoleBinding</strong> to bind Kubernetes user <code>dev-user</code> to the <code>developer-cluster-role</code>:</p><pre class="highlight yaml"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-user-cluster-role-binding</span>
<span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">User</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">dev-user</span> <span class="c1"># Kubernetes User mapped to the IAM user in aws-auth configmap.</span>
    <span class="na">apiGroup</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">eks-developer-cluster-role</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre></li><li><p>Map IAM user <code>arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:user/dev-user</code> to Kubernetes user <code>dev-user</code> in <code>aws-auth</code> configMap:<br><br></p></li></ol><div class="highlight js-code-highlight"><pre class="highlight shell"><code>  eksctl create iamidentitymapping <span class="se">\</span>
    <span class="nt">--cluster</span> iam-auth-cluster <span class="se">\</span>
    <span class="nt">--region</span> us-east-1 <span class="se">\</span>
    <span class="nt">--arn</span> <span class="s2">"arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:user/dev-user"</span> <span class="se">\</span>
    <span class="nt">--username</span> <span class="s2">"dev-user"</span>
</code></pre><div class="highlight__panel js-actions-panel"><div><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">Once this </span><code style="font-weight: var(--font-weight-normal);">ClusterRoleBinding</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> is created and the IAM user is mapped in </span><code style="font-weight: var(--font-weight-normal);">aws-auth</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">, IAM user </span><code style="font-weight: var(--font-weight-normal);">dev-user</code><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> would be able to get, list, or watch pods in any namespace.</span></div></div></div><h3> </h3><h3><a name="rbac-permissions-with-kubernetes-groups" href="https://dev.to/aws-builders/eks-auth-deep-dive-4fib#rbac-permissions-with-kubernetes-groups"></a>RBAC permissions with Kubernetes Groups</h3><p>If we need to give the same set of permissions to multiple users, then instead of creating multiple <code>ClusterRoleBindings</code>, we can use Kubernetes Groups and attach that group to the users for whom those permissions are required.</p><ol><li><p>Create a ClusterRoleBinding to bind Kubernetes Group <code>developer</code> to cluster role <code>eks-developer-cluster-role</code>:</p><pre class="highlight yaml"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">rbac.authorization.k8s.io/v1beta1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRoleBinding</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">dev-user-group-cluster-role-binding</span>
<span class="na">subjects</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">kind</span><span class="pi">:</span> <span class="s">Group</span>
    <span class="na">name</span><span class="pi">:</span> <span class="s">dev</span>
    <span class="na">apiGroup</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
<span class="na">roleRef</span><span class="pi">:</span>
  <span class="na">kind</span><span class="pi">:</span> <span class="s">ClusterRole</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">eks-developer-cluster-role</span>
  <span class="na">apiGroup</span><span class="pi">:</span> <span class="s2">"</span><span class="s">"</span>
</code></pre></li><li><p>Map IAM user <code>arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:user/dev-user</code> to Kubernetes user <code>dev-user</code> with <code>dev</code> group in <code>aws-auth</code> configMap:</p><pre class="highlight shell"><code>eksctl create iamidentitymapping <span class="se">\</span>
  <span class="nt">--cluster</span> iam-auth-cluster <span class="se">\</span>
  <span class="nt">--region</span> us-east-1 <span class="se">\</span>
  <span class="nt">--arn</span> <span class="s2">"arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/dev-user"</span> <span class="se">\</span>
  <span class="nt">--username</span> <span class="s2">"dev-user"</span> <span class="se">\</span>
  <span class="nt">--group</span> <span class="s2">"dev"</span>
</code></pre><p>this would create an entry under <code>mapUsers</code> section in <code>aws-auth</code> configmap as:</p><pre class="highlight yaml"><code><span class="na">mapUsers</span><span class="pi">:</span> <span class="pi">|</span>
  <span class="s">- groups:</span>
    <span class="s">- dev</span>
    <span class="s">userarn: arn:aws:iam::&lt;AWS_ACCOUNT_ID&gt;:role/dev-user</span>
    <span class="s">username: dev-user</span>
</code></pre></li></ol><h2> </h2><h2><a name="using-mapaccounts-to-map-iam-arn-in-an-aws-account-to-the-cluster" href="https://dev.to/aws-builders/eks-auth-deep-dive-4fib#using-mapaccounts-to-map-iam-arn-in-an-aws-account-to-the-cluster"></a>Using mapAccounts to Map IAM ARN in an AWS Account to the Cluster</h2><p><code>mapAccounts</code> allows mapping all the <code>IAM Users</code> or <code>IAM Roles</code> of an <strong>AWS account</strong> to the cluster. It accepts the list of AWS Account IDs:</p><div class="highlight js-code-highlight"><pre class="highlight yaml"><code><span class="na">mapAccounts</span><span class="pi">:</span> <span class="pi">|</span>
  <span class="s">- "&lt;AWS_ACCOUNT_ID_1&gt;"</span>
  <span class="s">- "&lt;AWS_ACCOUNT_ID_2&gt;"</span>
</code></pre><div class="highlight__panel js-actions-panel"><div class="highlight__panel-action js-fullscreen-code-action"><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);">After mapping the AWS accounts to the cluster, we can use </span><strong style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit;">Kubernetes User</strong><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> and </span><strong style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit;">Kubernetes Group</strong><span style="color: var(--text-editor-body-color); font-family: var(--font-base); font-size: inherit; font-weight: var(--font-weight-normal);"> to assign permissions to those IAM entities.</span></div></div></div></div><footer class="post__inner post__footer"><p class="post__last-updated">This article was updated on Jan 29, 2022</p><div class="post__bio"><img src="https://www.gravatar.com/avatar/f9bb8b993116996cdc108516ef1a5022?s&#x3D;240" loading="lazy" alt="Toyhoshi"><div><h3><a href="https://www.clouday.dev/authors/toyhoshi/" class="invert" rel="author">Toyhoshi</a></h3><p>I&#x27;m Marco Varagnolo aka Toyhoshi, the author behind Clouday.dev, curious about everything by nature, i&#x27;m a system architect. Huge supporter of DevOps mindset. My hands are dirty all day long with Kubernetes, containers and many similar things in between. What else do you need? :-)</p></div></div></footer></article></div></div><div id="sidebar"><div class="inner"><div id="search" class="alt"><form action="https://www.clouday.dev/search.html"><input type="text" name="q" placeholder="search..." aria-label="Search"></form></div><nav id="menu"><header class="major"><h2>Menu</h2></header><ul><li><a href="https://www.clouday.dev/" target="_self">Home</a></li><li class="has-submenu"><span aria-haspopup="true" class="opener">Categories</span><ul class="submenu level-2" aria-hidden="true"><li><a href="https://www.clouday.dev/iac/" title="Infrastructure as code" target="_self">IaC</a></li><li><a href="https://www.clouday.dev/ecs/" title="Elastic Container Service" target="_self">ECS</a></li></ul></li></ul></nav><footer id="footer"><p><a class="twitter-timeline" data-dnt="true" data-chrome="transparent,nofooter" data-link-color="#ffcc00" data-tweet-limit="1" href="https://twitter.com/learnk8s">Kubernetes Journey</a><script async="" src="https://platform.twitter.com/widgets.js" charset="utf-8"></script><img src="https://www.clouday.dev/media/files/LogoCloudayBar.png" alt="www.clouday.dev" width="100%" align="middle"></p></footer></div></div></div><script src="https://www.clouday.dev/assets/js/jquery.min.js?v=7c14a783dfeb3d238ccd3edd840d82ee"></script><script src="https://www.clouday.dev/assets/js/browser.min.js?v=c07298dd19048a8a69ad97e754dfe8d0"></script><script src="https://www.clouday.dev/assets/js/breakpoints.min.js?v=81a479eb099e3b187613943b085923b8"></script><script src="https://www.clouday.dev/assets/js/util.min.js?v=cbdaf7c20ac2883c77ae23acfbabd47e"></script><script src="https://www.clouday.dev/assets/js/main.min.js?v=448f4c9d4b4c374766a1cb76c3d88048"></script><script>var images=document.querySelectorAll("img[loading]");for(var i=0;i<images.length;i++){if(images[i].complete){images[i].classList.add("is-loaded")}else{images[i].addEventListener("load",function(){this.classList.add("is-loaded")},false)}};</script></body></html>